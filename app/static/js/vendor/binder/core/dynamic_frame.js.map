{"version":3,"sources":["../../../../../src/static/js/binder/core/dynamic_frame.js"],"sourcesContent":["import { Controller } from \"../controller.js\";\nimport { parseDuration, parseBoolean } from \"../util.js\";\n\n/*\nThis is the base controller for DynamicFrames\nExtend this and override params() and optionally replaceContent()\n\nThe root HTML node must have a `:url` attribute - this can be relative or absolute\nTo pass params use the attribute format `:param-name`\n\nExample HTML:\n<dynamic-frame :url=\"/some/url\" :param-day=\"Monday\"></dynamic-frame>\n*/\n\n/**\n * @class\n * @name DynamicFrame\n * @namespace DynamicFrame\n * @property url - The URL to fetch\n * @property executeScripts - If true will find and execute scripts in the response body\n * @property mode - The mode to use for adding the response content, either `replace`, `append` or `prepend` (Defaults to `replace`)\n * @property mountPoint - A selector used to find the element to mount to within the element (defaults to the root element)\n * @property autoRefresh - Will call `refresh()` automatically at the specified interval (Intervals are in the format `${num}${unit}` where unit is one of ms, s, m, h: `10s` = 10 seconds)\n * @property delay - An artificial delay applied before displaying the content\n * @property stateKey - An optional key, if specified the frame state will be stored and loaded from the page query string\n * @property contained - If `true` then the frame will be self contained, clicking links and submitting forms will be handled within the frame and **not** impact the surrounding page\n * @example\n *  <dynamic-frame :url=\"/some/url\" :param-day=\"Monday\" :mount-point=\".content\">\n *     <div class=\"content\"></div>\n *  </dynamic-frame>\n */\nclass DynamicFrame extends Controller {\n    /**\n     * Setup the DynamicFrame and do the initial request/load\n     * @memberof! DynamicFrame\n     *\n     */\n    async init() {\n        this.contents = \"\";\n\n        // Keep track of pending requests so we can cancel when updating multiple things\n        this._reqAbort = [];\n\n        this.args.executeScripts = parseBoolean(this.args.executeScripts);\n\n        if (this.args.autoRefresh) {\n            const interval = parseDuration(this.args.autoRefresh);\n            this.setAutoRefresh(interval);\n        }\n\n        if (!this.args.delay) this.args.delay = 0;\n\n        // If we have a stateKey then track and handle the state\n        if (this.args.stateKey) {\n            this.loadState();\n\n            const handleStateChange = () => {\n                let qs = this.loadState();\n\n                if (this._internal.currentQs !== qs) {\n                    this._internal.currentQs = qs;\n                    this.refresh();\n                }\n            };\n\n            // When the history state changes then reload our state\n            // This is triggered when going back and forward in the browser\n            window.addEventListener(\"popstate\", () => handleStateChange());\n            window.addEventListener(\"pushstate\", () => handleStateChange());\n        }\n\n        if (parseBoolean(this.args.contained)) {\n            this.containFrame();\n        }\n\n        await this.loadContent();\n    }\n\n    /**\n     * Reload the frame content then call `render()`\n     * @memberof! DynamicFrame\n     */\n    async refresh() {\n        await this.loadContent();\n        await this.render();\n    }\n\n    /**\n     * Call the base `bind()` and re-find the mountPoint in case it's changed\n     * @memberof! DynamicFrame\n     */\n    bind() {\n        super.bind();\n\n        // Find the mount point\n        if (this.args.mountPoint && typeof this.args.mountPoint === \"string\") {\n            this.mountPoint = this.querySelector(this.args.mountPoint);\n        }\n\n        if (!this.mountPoint) {\n            this.mountPoint = this.root;\n        }\n    }\n\n    /**\n     * Sets an interval to auto call `this.refresh()`\n     * Overwrites previously set refresh intervals\n     * @param {*} interval Duration in milliseconds\n     * @memberof! DynamicFrame\n     */\n    setAutoRefresh(interval) {\n        if (interval === undefined) {\n            console.error(`[${this.tag}] Undefined interval passed to setAutoRefresh`);\n            return;\n        }\n\n        if (this._internal.autoRefreshInterval) {\n            window.clearInterval(this._internal.autoRefreshInterval);\n        }\n\n        this._internal.autoRefreshInterval = window.setInterval(() => this.refresh(), interval);\n    }\n\n    /**\n     * [async] Makes a new request and replaces or appends the response to the mountPoint\n     * Returns true on success\n     * Multiple calls will abort previous requests and return false\n     * @returns boolean - true on success\n     * @memberof! DynamicFrame\n     */\n    async loadContent(e) {\n        let url = this.endpoint();\n        url.search = new URLSearchParams(this.params());\n\n        // Keep track of all pending requests so we can abort them on duplicate calls\n        this._reqAbort.forEach(controller => controller.abort());\n        this._reqAbort = [];\n\n        const abortController = new AbortController();\n        this._reqAbort.push(abortController);\n\n        let ok = true;\n        const sendReq = async () => {\n            try {\n                let response = await fetch(url, { signal: abortController.signal });\n                let text = await response.text();\n                this.updateContent(text);\n                this.findAndExecuteScripts();\n            } catch (err) {\n                console.error(err);\n                ok = false;\n            }\n        };\n\n        await Promise.allSettled([new Promise(resolve => setTimeout(resolve, this.args.delay)), sendReq()]);\n        this.saveState();\n\n        return ok;\n    }\n\n    /**\n     * Called during `loadContent()`\n     * Will find all script tags within the frame and execute them\n     * Only if the frame has the `execute-scripts` attribute set to true\n     * @memberof! DynamicFrame\n     */\n    findAndExecuteScripts() {\n        if (!this.args.executeScripts) return;\n\n        let scripts = this.querySelectorAll(\"script\");\n        if (!scripts) return;\n\n        [...scripts].forEach(script => {\n            let newScript = document.createElement(\"script\");\n            newScript.setAttribute(\"type\", script.type || \"text/javascript\");\n\n            if (script.getAttribute(\"src\")) {\n                newScript.setAttribute(\"src\", script.getAttribute(\"src\"));\n                this.appendChild(newScript);\n            } else {\n                newScript.appendChild(document.createTextNode(script.innerHTML));\n                this.appendChild(newScript);\n            }\n        });\n    }\n\n    /**\n     * Actually updates the content\n     * This is where the artificial delay is applied\n     * @param content - The content to use\n     * @param mode - replace or append, defaults to `this.args.mode`\n     * @memberof! DynamicFrame\n     */\n    updateContent(content, mode = null) {\n        if (!mode) mode = this.args.mode || \"replace\";\n\n        if (mode === \"replace\") {\n            this.mountPoint.innerHTML = content;\n        } else if (mode === \"append\") {\n            this.mountPoint.insertAdjacentHTML(\"beforeEnd\", content);\n        } else if (mode === \"prepend\") {\n            this.mountPoint.insertAdjacentHTML(\"afterBegin\", content);\n        }\n    }\n\n    /**\n     * Returns the query string params for the request - expected to be overridden\n     * Handles arrays as duplicated params (ie. a: [1,2] => ?a=1&a=2)\n     * @returns {URLSearchParams}\n     * @memberof! DynamicFrame\n     */\n    params(values = {}) {\n        let params = new URLSearchParams(values);\n\n        // Annoyingly URLSearchParams can't handle array params unless you call .append each time\n        // So find any array params and re-add them manually\n        Object.entries(values).forEach(([key, val]) => {\n            if (Array.isArray(val)) {\n                params.delete(key);\n                val.forEach(item => params.append(key, item));\n            }\n        });\n\n        for (let attr of this.attributes) {\n            if (attr.nodeName.startsWith(\":param-\")) {\n                params.append(attr.nodeName.substr(7), attr.nodeValue);\n            }\n        }\n\n        return params;\n    }\n\n    /**\n     * Set key/value pairs of params in the element attributes\n     * @param {object} values\n     */\n    setParams(values = {}) {\n        // Wipe out all current attributes\n        for (let attr of this.attributes) {\n            if (attr.nodeName.startsWith(\":param-\")) {\n                this.removeAttribute(attr.nodeName);\n            }\n        }\n\n        // Set the new params\n        Object.entries(values).forEach(([key, val]) => {\n            this.setAttribute(`:param-${key}`, val);\n        });\n    }\n\n    /**\n     * Returns the endpoint to call - from the data-url attr on the root element\n     * @returns {string}\n     * @memberof! DynamicFrame\n     */\n    endpoint() {\n        let url = this.args.url;\n\n        if (!this.args.url) {\n            console.error(`${this.tag}: No :url attribute specified`);\n            return;\n        }\n\n        if (!url.startsWith(\"http\")) url = window.location.origin + url;\n        return new URL(url);\n    }\n\n    /**\n     * Load the frame state based on the URL query string\n     */\n    loadState() {\n        if (!this.args.stateKey) return;\n\n        let qs = window.location.search;\n        if (!qs) return;\n\n        qs = qs.substring(1);\n        let qsParts = Object.fromEntries(qs.split(\"&\").map(part => part.split(\"=\")));\n\n        if (qsParts[`${this.args.stateKey}-url`]) {\n            this.args.url = qsParts[`${this.args.stateKey}-url`];\n            delete qsParts[`${this.args.stateKey}-url`];\n        }\n\n        // TODO: Rewrite this to use `setParams`\n\n        // Wipe out the default param attributes on this frame as we add the correct ones below\n        for (let attr of this.attributes) {\n            if (attr.nodeName.startsWith(\":param-\")) {\n                this.removeAttribute(attr.nodeName);\n            }\n        }\n\n        for (let [key, value] of Object.entries(qsParts)) {\n            // Ignore other state keys\n            // TODO: It might be better to make the state keys easier to identify\n            // I can see these two cases being used for real parameters, in which case we drop them\n            if (key.endsWith(\"-url\")) continue;\n            if (!key.startsWith(this.args.stateKey)) continue;\n\n            key = key.replace(`${this.args.stateKey}-param-`, \"\");\n            this.setAttribute(`:param-${key}`, value);\n        }\n\n        return qs;\n    }\n\n    /**\n     * Save the frame state to the URL query string\n     * Only saves if the state has changed\n     */\n    saveState() {\n        if (!this.args.stateKey) return;\n\n        let qsParts = Object.fromEntries(new URLSearchParams(window.location.search));\n        qsParts[`${this.args.stateKey}-url`] = this.args.url;\n\n        // Strip out any params that belong to this frame\n        // We re-add them below\n        for (const key of Object.keys(qsParts)) {\n            if (key.startsWith(`${this.args.stateKey}-param-`)) {\n                delete qsParts[key];\n            }\n        }\n\n        // Add the params for this fra,e\n        for (const [key, value] of this.params()) {\n            qsParts[`${this.args.stateKey}-param-${key}`] = value;\n        }\n\n        const qs = Object.entries(qsParts)\n            .map(part => `${part[0]}=${part[1]}`)\n            .join(\"&\");\n\n        if (this._internal.currentQs !== qs) {\n            window.history.pushState(qs, \"\", `?${qs}`);\n            this._internal.currentQs = qs;\n        }\n    }\n\n    /**\n     * Makes the frame self contained\n     * Clicking any links or submitting any forms will only impact the frame, not the surrounding page\n     */\n    containFrame() {\n        /**\n         * Loads a URL into the frame by updating the url and param attributes\n         * @param {*} url\n         */\n        const loadUrl = url => {\n            let [origin, query] = url.split(\"?\");\n            if (!query) query = \"\";\n            const params = Object.fromEntries(query.split(\"&\").map(part => part.split(\"=\")));\n\n            this.setParams(params);\n            this.args.url = origin;\n        };\n\n        // Capture all clicks and if it was on an <a> tag load the href within the frame\n        this.addEventListener(\"click\", e => {\n            let target = e.target || e.srcElement;\n\n            if (target.tagName === \"A\" && this.belongsToController(target)) {\n                e.preventDefault();\n                const href = target.getAttribute(\"href\");\n                loadUrl(href);\n                this.loadContent();\n            }\n        });\n\n        // Intercept form submits\n        // To do this we need to submit the form ourselves\n        // Aims to have near-full feature parity with regular HTML forms\n        // We do not support the `target` attribute or the `method=\"dialog\"` value\n        // https://developer.mozilla.org/en-US/docs/Web/HTML/Element/form\n        this.addEventListener(\"submit\", async e => {\n            e.preventDefault();\n\n            const method = e.target.getAttribute(\"method\") || \"GET\";\n            const action = e.target.getAttribute(\"action\") || \"/\";\n            const encoding = e.target.getAttribute(\"enctype\") || \"application/x-www-form-urlencoded\";\n            const skipValidation = e.target.getAttribute(\"novalidate\") !== undefined;\n\n            // Base HTML5 validation\n            if (!skipValidation && !e.target.checkValidity()) {\n                console.warn(\"Form is not valid\");\n                return;\n            }\n\n            const formData = new FormData(e.target);\n\n            if (method.toUpperCase() == \"POST\") {\n                let response = await fetch(action, {\n                    method: \"POST\",\n                    body: formData,\n                    headers: {\n                        \"Content-Type\": encoding,\n                    },\n                });\n\n                if (response.redirected) {\n                    // If we have a redirect then follow it\n                    loadUrl(response.url);\n                    this.render();\n                } else {\n                    // Otherwise show the response body\n                    this.innerHTML = await response.text();\n                }\n            } else if (method.toUpperCase() == \"GET\") {\n                const query = Object.fromEntries(new URLSearchParams(formData));\n                this.setParams(query);\n                this.args.url = action;\n                this.render();\n            }\n\n            return false;\n        });\n    }\n}\n\nexport { DynamicFrame };\n"],"names":["Controller","parseDuration","parseBoolean","DynamicFrame","init","contents","_reqAbort","args","executeScripts","autoRefresh","interval","setAutoRefresh","delay","stateKey","loadState","handleStateChange","qs","_internal","currentQs","refresh","window","addEventListener","contained","containFrame","loadContent","render","bind","mountPoint","querySelector","root","undefined","console","error","tag","autoRefreshInterval","clearInterval","setInterval","e","url","endpoint","search","URLSearchParams","params","forEach","controller","abort","abortController","AbortController","push","ok","sendReq","response","fetch","signal","text","updateContent","findAndExecuteScripts","err","Promise","allSettled","resolve","setTimeout","saveState","scripts","querySelectorAll","script","newScript","document","createElement","setAttribute","type","getAttribute","appendChild","createTextNode","innerHTML","content","mode","insertAdjacentHTML","values","Object","entries","key","val","Array","isArray","delete","item","append","attr","attributes","nodeName","startsWith","substr","nodeValue","setParams","removeAttribute","location","origin","URL","substring","qsParts","fromEntries","split","map","part","value","endsWith","replace","keys","join","history","pushState","loadUrl","query","target","srcElement","tagName","belongsToController","preventDefault","href","method","action","encoding","skipValidation","checkValidity","warn","formData","FormData","toUpperCase","body","headers","redirected"],"mappings":"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"}